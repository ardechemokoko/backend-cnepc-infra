services:
  postgres:
    image: postgres:15-alpine
    container_name: backend-cnepc-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: cnepc_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5450:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: backend-cnepc-redis
    restart: unless-stopped
    ports:
      - "6382:6379"
    volumes:
      - redis_data:/data
    networks:
      - backend-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    image: ghcr.io/ardechemokoko/backend-cnepc:latest
    container_name: backend-cnepc-app
    restart: unless-stopped
    command: ["sh", "-c", "php artisan queue:work --sleep=3 --tries=3 & exec php artisan serve --host=0.0.0.0 --port=8000"]
    ports:
      - "8006:8000"
    environment:
      # Variables d'environnement du container - elles dominent
      # Laravel App
      APP_NAME: CNEPC
      APP_ENV: local
      APP_KEY: base64:AGDIfwfRUKYRdvfOP3APMxnTzxeHiNeGCRQEu723+8E=
      APP_DEBUG: true
      APP_URL: http://86.48.5.209:8004
      
      # Base de donn√©es PostgreSQL (Laravel)
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: cnepc_db
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/cnepc_db
      
      # Redis (Laravel)
      REDIS_HOST: redis
      REDIS_PASSWORD: null
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_URL: redis://redis:6379
      
      # Cache & Session (Laravel)
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      
      # Alfresco
      ALFRESCO_URL: http://62.171.169.115:8080
      ALFRESCO_USER: admin
      ALFRESCO_PASS: admin
      
      # Mail
      MAIL_MAILER: smtp
      MAIL_HOST: sandbox.smtp.mailtrap.io
      MAIL_PORT: 2525
      MAIL_USERNAME: 7cbb472a90865a
      MAIL_PASSWORD: c8456fa8e965eb
      MAIL_ENCRYPTION: tls
      
      # AWS
      AWS_ACCESS_KEY_ID: ""
      AWS_SECRET_ACCESS_KEY: ""
      AWS_DEFAULT_REGION: us-east-1
      AWS_BUCKET: ""
      AWS_USE_PATH_STYLE_ENDPOINT: false
      
      # Vite
      VITE_APP_NAME: "CNEPC"
      
      # Authentik
      AUTHENTIK_BASE_URL: http://86.48.5.209:9000/                                                                                                                                                                                                                  
      AUTHENTIK_CLIENT_ID: IxMKOfPuW3lVbSwGxpXSgpcptbrekbXc6KUk8sQ9                                                                                                                                                                                                        
      AUTHENTIK_CLIENT_SECRET: UHpF4Y1wNAghsT9Ysu9axnrdn8hgxwKNBc0RriKs5DwwdNPeeicxQa7POzSSLkZZanwAcYyT0vCd8YwCCohWDqS68QujCc1ICMlKUUGObP7FN0wgFOFMvsfMiqQgDYWL                                                                                                            
      AUTHENTIK_REDIRECT_URI: http://62.171.169.115:9000/api/auth/authentik/callback                                                                                                                                                                                   
      AUTHENTIK_API_TOKEN: xZsEQBhRrAk26DVlr504onOmOgttZpCeGO0AWVuREbV1XrDsLiKwKcT7GQ2E
      
      # CNEDDT API
      CNEDDT_API_URL: https://backend-cneddt.application-dev.site/api/v1/external/driving-license
      CNEDDT_API_KEY: ext_a3f7b2c1d5e8f1a29b3c4d5e6f7a8b9c

      #########EDI DGDI
      DGDI_BASE_URL: https://edgdi.dgdi.ga/be
      
      # Captcha
      CAPTCHA_LENGTH: 6
      CAPTCHA_WIDTH: 160
      CAPTCHA_HEIGHT: 60
      CAPTCHA_TTL: 120
      CAPTCHA_BACKGROUND: "#f5f5f5"
      CAPTCHA_TEXT_COLOR: "#1a1a1a"
      CAPTCHA_NOISE: 30

      AIRTEL_SMS_HOST: https://messaging.airtel.ga:9002/smshttpquery/qs
      AIRTEL_SMS_USERNAME: RANGUS
      AIRTEL_SMS_PASSWORD: Dec@9080
      AIRTEL_SMS_SENDER_ID: DGTT
      
      # VAPID (Web Push Notifications)
      VAPID_PUBLIC_KEY: BNhOSbppnYNeuxZ8l8G5XBe7nqiPWAMvLns70z41-4zm20xN2jVbhqkGU5qbSLjiYlO-20wt38aUVVF6uvicH6E
      VAPID_PRIVATE_KEY: I_KkpI3evNaheP4KASPx2_s392NF_05mey4xYnZZ8aw
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  backend-network:
    driver: bridge
